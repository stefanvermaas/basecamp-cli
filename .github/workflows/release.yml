name: Release

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
            ext: .exe

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ github.ref_name }}
          EXT: ${{ matrix.ext }}
        run: |
          mkdir -p dist
          go build -trimpath -ldflags "-s -w -X main.version=${VERSION}" -o "dist/basecamp-${GOOS}-${GOARCH}${EXT}" ./cmd/basecamp

      - name: Checksums
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
        run: |
          cd dist
          sha256sum "basecamp-${GOOS}-${GOARCH}${EXT}" > "SHA256SUMS-${GOOS}-${GOARCH}.txt"

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/basecamp-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}
            dist/SHA256SUMS-${{ matrix.goos }}-${{ matrix.goarch }}.txt

  build-packages:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            rpm_arch: x86_64
          - arch: arm64
            goarch: arm64
            rpm_arch: aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Install packaging tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Download binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          curl -sL "https://github.com/robzolkos/basecamp-cli/releases/download/v${VERSION}/basecamp-linux-${{ matrix.goarch }}" -o basecamp
          chmod +x basecamp

      - name: Build .deb package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          PKG_ROOT="basecamp-cli_${VERSION}_${{ matrix.arch }}"

          mkdir -p "${PKG_ROOT}/DEBIAN"
          mkdir -p "${PKG_ROOT}/usr/bin"
          mkdir -p "${PKG_ROOT}/usr/share/doc/basecamp-cli"

          cp basecamp "${PKG_ROOT}/usr/bin/basecamp"
          cp LICENSE "${PKG_ROOT}/usr/share/doc/basecamp-cli/copyright"

          cat > "${PKG_ROOT}/DEBIAN/control" << EOF
          Package: basecamp-cli
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Rob Zolkos <rob@zolkos.com>
          Description: CLI for interacting with Basecamp projects and card tables
           A command-line interface for the Basecamp API.
          Homepage: https://github.com/robzolkos/basecamp-cli
          EOF

          sed -i 's/^          //' "${PKG_ROOT}/DEBIAN/control"

          dpkg-deb --build "${PKG_ROOT}"

      - name: Build .rpm package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/BUILDROOT/basecamp-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/bin
          mkdir -p rpmbuild/BUILDROOT/basecamp-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/share/licenses/basecamp-cli

          cp basecamp rpmbuild/BUILDROOT/basecamp-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/bin/basecamp
          cp LICENSE rpmbuild/BUILDROOT/basecamp-cli-${VERSION}-1.${{ matrix.rpm_arch }}/usr/share/licenses/basecamp-cli/LICENSE

          cat > rpmbuild/SPECS/basecamp-cli.spec << EOF
          Name:           basecamp-cli
          Version:        ${VERSION}
          Release:        1
          Summary:        CLI for interacting with Basecamp projects and card tables
          License:        MIT
          URL:            https://github.com/robzolkos/basecamp-cli

          %description
          A command-line interface for the Basecamp API.

          %files
          %license /usr/share/licenses/basecamp-cli/LICENSE
          /usr/bin/basecamp
          EOF

          rpmbuild --define "_topdir $(pwd)/rpmbuild" \
                   --define "_rpmdir $(pwd)/rpmbuild/RPMS" \
                   --target ${{ matrix.rpm_arch }} \
                   -bb rpmbuild/SPECS/basecamp-cli.spec

          cp rpmbuild/RPMS/${{ matrix.rpm_arch }}/*.rpm .

      - name: Upload packages to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            basecamp-cli_*_${{ matrix.arch }}.deb
            basecamp-cli-*.rpm

  aur-publish:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    steps:
      - name: Generate PKGBUILD
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # Download source tarball and calculate checksum
          curl -sL "https://github.com/robzolkos/basecamp-cli/archive/v${VERSION}.tar.gz" -o source.tar.gz
          SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)

          # Generate PKGBUILD
          cat > PKGBUILD << 'EOF'
          # Maintainer: Rob Zolkos <rob@zolkos.com>
          pkgname=basecamp-cli
          pkgver=VERSION_PLACEHOLDER
          pkgrel=1
          pkgdesc="CLI for interacting with Basecamp projects and card tables"
          arch=('x86_64' 'aarch64')
          url="https://github.com/robzolkos/basecamp-cli"
          license=('MIT')
          depends=('glibc')
          makedepends=('go')
          source=("$pkgname-$pkgver.tar.gz::https://github.com/robzolkos/basecamp-cli/archive/v$pkgver.tar.gz")
          sha256sums=('SHA256_PLACEHOLDER')
          options=('!debug')

          build() {
              cd "$pkgname-$pkgver"
              export CGO_CPPFLAGS="${CPPFLAGS}"
              export CGO_CFLAGS="${CFLAGS}"
              export CGO_CXXFLAGS="${CXXFLAGS}"
              export CGO_LDFLAGS="${LDFLAGS}"
              export GOFLAGS="-buildmode=pie -trimpath -mod=readonly -modcacherw"
              go build -ldflags "-s -w -X main.version=${pkgver}" -o basecamp ./cmd/basecamp
          }

          package() {
              cd "$pkgname-$pkgver"
              install -Dm755 basecamp "$pkgdir/usr/bin/basecamp"
              install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
          }
          EOF

          # Remove leading whitespace from PKGBUILD
          sed -i 's/^          //' PKGBUILD

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/" PKGBUILD
          sed -i "s/SHA256_PLACEHOLDER/$SHA256/" PKGBUILD

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: basecamp-cli
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ github.ref_name }}"

  homebrew-publish:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    steps:
      - name: Update Homebrew Formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # Download SHA256 files
          curl -sL "https://github.com/robzolkos/basecamp-cli/releases/download/v${VERSION}/SHA256SUMS-darwin-amd64.txt" -o sha256-amd64.txt
          curl -sL "https://github.com/robzolkos/basecamp-cli/releases/download/v${VERSION}/SHA256SUMS-darwin-arm64.txt" -o sha256-arm64.txt

          SHA256_AMD64=$(cut -d' ' -f1 sha256-amd64.txt)
          SHA256_ARM64=$(cut -d' ' -f1 sha256-arm64.txt)

          # Generate formula
          cat > basecamp-cli.rb << 'FORMULA'
          class BasecampCli < Formula
            desc "CLI for interacting with Basecamp projects and card tables"
            homepage "https://github.com/robzolkos/basecamp-cli"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/robzolkos/basecamp-cli/releases/download/v#{version}/basecamp-darwin-arm64"
                sha256 "SHA256_ARM64_PLACEHOLDER"
              else
                url "https://github.com/robzolkos/basecamp-cli/releases/download/v#{version}/basecamp-darwin-amd64"
                sha256 "SHA256_AMD64_PLACEHOLDER"
              end
            end

            def install
              binary_name = Hardware::CPU.arm? ? "basecamp-darwin-arm64" : "basecamp-darwin-amd64"
              bin.install binary_name => "basecamp"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/basecamp --version")
            end
          end
          FORMULA

          # Remove leading whitespace and replace placeholders
          sed -i 's/^          //' basecamp-cli.rb
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" basecamp-cli.rb
          sed -i "s/SHA256_ARM64_PLACEHOLDER/${SHA256_ARM64}/" basecamp-cli.rb
          sed -i "s/SHA256_AMD64_PLACEHOLDER/${SHA256_AMD64}/" basecamp-cli.rb

          # Clone tap repo, update formula, push
          git clone https://x-access-token:${GH_TOKEN}@github.com/robzolkos/homebrew-tap.git
          cd homebrew-tap
          cp ../basecamp-cli.rb basecamp-cli.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add basecamp-cli.rb
          git commit -m "Update basecamp-cli to ${VERSION}"
          git push
